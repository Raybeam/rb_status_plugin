#!/usr/bin/env python3
# PYTHON_ARGCOMPLETE_OK
# -*- coding: utf-8 -*-
#
import os
import logging
import argparse
import shutil
import sys

from airflow.configuration import conf
from airflow.models import Variable

manual_instructions = f"""
    MANUAL SETUP INSTRUCTIONS:

    For one reason or another we couldn't set up your system for you.  Have
    no fear, it's easy to do it yourself.

    Just copy the rb_status.py file from the rb_status_plugin/setup directory into
    your DAGs folder.  That's it.  rb Status will take care of the rest.

    It might be something like:
    > cp $AIRFLOW_HOME/plugins/rb_status_plugin/setup/rb_status.py $AIRFLOW_HOME/dags/

    If you'd like a sample DAG that fails and succeeds randomly to test our rb Status,
    copy the rb_status_sample_dag.py into your DAGs folder.
    """


def find_dags_folder():
    dags_folder = conf.get("core", "dags_folder")
    if dags_folder and os.path.isdir(dags_folder):
        logging.info(f"Assuming DAGs folder at {dags_folder}")
        return dags_folder
    logging.warning(
        f"Could not find DAGs folder at {dags_folder}, trying $AIRFLOW_HOME."
    )

    airflow_home = os.environ.get("AIRFLOW_HOME")
    if airflow_home:
        dags_folder = os.path.join(airflow_home, "dags")
        if dags_folder and os.path.isdir(dags_folder):
            logging.info(f"Assuming DAGs folder at {dags_folder}")
            return dags_folder
        logging.warning(f"Could not find DAGs folder at {dags_folder}, trying $PWD.")

    dags_folder = os.path.join(os.environ["PWD"], "dags")
    if dags_folder and os.path.isdir(dags_folder):
        logging.info(f"Assuming DAGs folder at {dags_folder}")
        return dags_folder
    logging.warning(f"Could not find DAGs folder at {dags_folder}, out of options.")

    raise OSError(f"Could not find DAGs folder path")


def find_rb_status_setup_path():
    plugins_folder = conf.get("core", "plugins_folder")
    rb_status_setup_path = os.path.join(plugins_folder, "rb_status_plugin", "setup")
    if rb_status_setup_path and os.path.isdir(rb_status_setup_path):
        logging.info(f"Assuming rb Status setup path at {rb_status_setup_path}")
        return rb_status_setup_path
    logging.warning(
        f"Could not find rb Status setup path at {rb_status_setup_path}, trying $AIRFLOW_HOME."
    )

    airflow_home = os.environ.get("AIRFLOW_HOME")
    if airflow_home:
        rb_status_setup_path = os.path.join(
            airflow_home, "plugins", "rb_status_plugin", "setup"
        )
        if rb_status_setup_path and os.path.isdir(rb_status_setup_path):
            logging.info(f"Assuming rb Status setup path at {rb_status_setup_path}")
            return rb_status_setup_path
        logging.warning(
            f"Could not find rb Status setup path at {rb_status_setup_path}, trying $PWD"
        )

    rb_status_setup_path = os.path.join(
        os.environ["PWD"], "plugins", "rb_status_plugin", "setup"
    )
    if rb_status_setup_path and os.path.isdir(rb_status_setup_path):
        logging.info(f"Assuming rb Status setup path at {rb_status_setup_path}")
        return rb_status_setup_path
    logging.warning(f"Could not find rb Status setup path at {rb_status_setup_path}.")

    raise OSError(f"Could not find rb Status setup path")


def find_sample_reports(rb_status_setup_path):
    report_files = {}
    for root, _, files in os.walk(os.path.join(rb_status_setup_path, "reports")):
        for name in files:
            fname, ext = os.path.splitext(name)
            if ext == ".json":
                report_files[fname] = os.path.join(root, name)

    return report_files


def init(args):
    logging.info(args.dry)
    try:
        logging.info("Starting rb Status initialization")

        dags_folder = find_dags_folder()
        rb_status_setup_path = find_rb_status_setup_path()

        logging.info(
            f"Copying rb_status.py from {rb_status_setup_path} to {dags_folder}"
        )
        if not args.dry:
            shutil.copy(os.path.join(rb_status_setup_path, "rb_status.py"), dags_folder)

        if not os.path.isfile(os.path.join(rb_status_setup_path, "rb_status.py")):
            err = (
                "Could not find file after copying, "
                + "check that rb_status.py exists in your DAGs folder"  # noqa: W503
            )
            raise OSError(err)
    except Exception:
        print(manual_instructions)
        raise


def add_samples(args):
    try:
        rb_status_setup_path = find_rb_status_setup_path()

        add_sample_dag(rb_status_setup_path, args)
        if args.dag_only:
            return

        report_files = find_sample_reports(rb_status_setup_path)
        for fname, path in report_files.items():
            report_name = f"rb_status_report_{fname}"
            logging.info(f"Adding report {report_name} with json at {path}")
            if not args.dry:
                with open(path) as f:
                    s = f.read()
                    Variable.set(report_name, s)
    except Exception:
        print(manual_instructions)
        raise


def add_sample_dag(rb_status_setup_path, args):
    dags_folder = find_dags_folder()

    logging.info("Adding rb Status sample DAG to DAGs folder")
    if not args.dry:
        shutil.copy(
            os.path.join(rb_status_setup_path, "rb_status_sample_dag.py"), dags_folder
        )

    if not os.path.isfile(
        os.path.join(rb_status_setup_path, "rb_status_sample_dag.py")
    ):
        err = (
            "Could not find file after copying, check "
            + "that rb_status_sample_dag.py exists in your DAGs folder"  # noqa: W503
        )
        raise OSError(err)


if __name__ == "__main__":

    if conf.get("core", "security") == "kerberos":
        os.environ["KRB5CCNAME"] = conf.get("kerberos", "ccache")
        os.environ["KRB5_KTNAME"] = conf.get("kerberos", "keytab")

    parser = argparse.ArgumentParser(
        description="""
    rbStatus is a plugin for Airflow that handles data confidence.  To operate, it needs
    to include a file in the DAGs folder.  A sample DAG is also provided if you'd like
    to get some sample data in the Airflow DB in order to try rbStatus out.
    """
    )
    subparsers = parser.add_subparsers()

    parser_init = subparsers.add_parser("init", help="Add rbStatus to the DAGs folder")
    parser_init.add_argument(
        "--dry", action="store_true", help="Do a dry run.  No files are moved."
    )
    parser_init.set_defaults(func=init)

    parser_sample = subparsers.add_parser(
        "add_samples",
        help="Add a sample DAG and Variables for random values and populated reports",
    )
    parser_sample.add_argument(
        "--dry",
        action="store_true",
        help="Do a dry run.  No files are moved.  No changes made.",
    )
    parser_sample.add_argument(
        "--dag_only", action="store_true", help="Add a sample DAG to seed the DB"
    )
    parser_sample.set_defaults(func=add_samples)

    args = parser.parse_args()
    if len(sys.argv) == 1:
        parser.print_help(sys.stderr)
        sys.exit(1)
    args.func(args)
